services:
  relay:
    build:
      context: .
      dockerfile: relay/Dockerfile
    container_name: zgate-relay
    sysctls:
      - net.ipv4.ip_forward=1
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./certs:/certs:ro
    environment:
      - USE_MTLS=${USE_MTLS:-true}
    ports:
      - "4433:4433/udp"
    networks:
      zgate-net:
        ipv4_address: 172.28.0.10

  agent:
    build:
      context: .
      dockerfile: agent/Dockerfile
    container_name: zgate-agent
    depends_on:
      - relay
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./certs:/certs:ro
    environment:
      - RELAY_URL=https://172.28.0.10:4433/
      - CLIENT_ID=client-1
      - USE_MTLS=${USE_MTLS:-true}
      - TARGET_CIDRS=8.8.8.8/32
    networks:
      zgate-net:
        ipv4_address: 172.28.0.20

networks:
  zgate-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
